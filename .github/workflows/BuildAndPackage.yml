name: CI Workflow

permissions:
  contents: write
  packages: write
  actions: write

on:
  push:
    tags:
      - '[0-9]*.[0-9]*'
      - '[0-9]*.[0-9]*.[0-9]*'

env:
  PKG_NAME: jtreesize
  MAIN_CLASS: org.ligson.jtreesize.App

jobs:
  build-and-package:
    strategy:
      matrix:
        include:
          - os: windows-latest
            architecture: x64
          - os: ubuntu-latest
            architecture: x64
          - os: ubuntu-latest
            architecture: aarch64
          - os: macos-latest
            architecture: x64
          - os: macos-latest
            architecture: aarch64
    runs-on: ${{ matrix.os }}
    name: Build on ${{ matrix.os }} with ${{ matrix.architecture }}
    outputs:
      version: ${{ steps.set-version.outputs.version }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 获取所有历史记录

      - name: Check Runner Architecture
        run: |
          echo "Runner architecture: $(uname -m)"

      - name: Set up JDK 21 and Maven Cache
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"  # 使用 Eclipse Temurin 发行版
          java-version: "21"
          cache: "maven"
          jvmArchitecture: ${{ matrix.architecture }}

      - name: Extract Version from POM (Windows)
        if: runner.os == 'Windows'
        id: get-version-windows
        shell: pwsh
        run: |
          $version = (mvn help:evaluate '-Dexpression=project.version' -q -DforceStdout)
          Write-Output "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Output "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8

      - name: Extract Version from POM (Linux and macOS)
        if: runner.os != 'Windows'
        id: get-version-linux-macos
        run: |
          version=$(mvn help:evaluate '-Dexpression=project.version' -q -DforceStdout)
          version=$(echo $version | xargs)  # 去除前后空格
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Set Job Output Version for Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          echo "version=${{ steps.get-version-windows.outputs.version }}" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8

      - name: Set Job Output Version for Linux and macOS
        if: runner.os != 'Windows'
        run: |
          echo "version=${{ steps.get-version-linux-macos.outputs.version }}" >> $GITHUB_OUTPUT

      - name: Verify VERSION
        run: echo "Extracted VERSION is ${{ steps.set-version.outputs.version }}"

      - name: Build with Maven
        run: mvn clean package '-Dmaven.test.skip=true'

      - name: Prepare Output Directory
        run: mkdir -p dist

      - name: Extract Packaged Archive
        run: |
          tar -zxvf target/${{ env.PKG_NAME }}-${{ steps.set-version.outputs.version }}-${{ env.PKG_NAME }}.tar.gz -C target/

      - name: Install WiX
        if: runner.os == 'Windows'
        run: dotnet tool install --global wix

      - name: Package Application with jpackage (Windows)
        if: runner.os == 'Windows'
        run: |
          jpackage `
            --input . `
            --name ${{ env.PKG_NAME }} `
            --main-jar lib/${{ env.PKG_NAME }}-${{ steps.set-version.outputs.version }}.jar `
            --main-class ${{ env.MAIN_CLASS }} `
            --type exe `
            --resource-dir conf `
            --icon conf/treesize.ico `
            --win-dir-chooser `
            --win-shortcut `
            --app-version ${{ steps.set-version.outputs.version }}
          Move-Item "${{ env.PKG_NAME }}-${{ steps.set-version.outputs.version }}.exe" "../../dist/${{ env.PKG_NAME }}-${{ steps.set-version.outputs.version }}-Windows-${{ matrix.architecture }}.exe"
        working-directory: target/${{ env.PKG_NAME }}-${{ steps.set-version.outputs.version }}

      - name: Package Application with jpackage (macOS)
        if: runner.os == 'macOS'
        run: |
          jpackage \
            --input . \
            --name ${{ env.PKG_NAME }} \
            --main-jar lib/${{ env.PKG_NAME }}-${{ steps.set-version.outputs.version }}.jar \
            --main-class ${{ env.MAIN_CLASS }} \
            --type dmg \
            --resource-dir conf \
            --icon conf/treesize.icns \
            --app-version ${{ steps.set-version.outputs.version }}
          mv ${{ env.PKG_NAME }}-${{ steps.set-version.outputs.version }}.dmg ../../dist/${{ env.PKG_NAME }}-${{ steps.set-version.outputs.version }}-macOS-${{ matrix.architecture }}.dmg
        working-directory: target/${{ env.PKG_NAME }}-${{ steps.set-version.outputs.version }}

      - name: Package Application with jpackage (Linux)
        if: runner.os == 'Linux'
        run: |
          jpackage \
            --input . \
            --name ${{ env.PKG_NAME }} \
            --main-jar lib/${{ env.PKG_NAME }}-${{ steps.set-version.outputs.version }}.jar \
            --main-class ${{ env.MAIN_CLASS }} \
            --type app-image \
            --resource-dir conf \
            --icon conf/treesize.png \
            --app-version ${{ steps.set-version.outputs.version }} \
            --dest ../../app-image

          # 压缩 app-image 目录为 tar.gz
          tar -czvf ${{ env.PKG_NAME }}-${{ steps.set-version.outputs.version }}-Linux-${{ matrix.architecture }}.tar.gz -C ../../ app-image/${{ env.PKG_NAME }}

          # 移动压缩包到 dist 目录
          mv ${{ env.PKG_NAME }}-${{ steps.set-version.outputs.version }}-Linux-${{ matrix.architecture }}.tar.gz ../../dist/
        working-directory: target/${{ env.PKG_NAME }}-${{ steps.set-version.outputs.version }}

      - name: List dist directory (Windows)
        if: runner.os == 'Windows'
        run: Get-ChildItem dist

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.PKG_NAME }}-${{ steps.set-version.outputs.version }}-${{ matrix.os }}-${{ matrix.architecture }}
          path: dist/

  generate-changelog:
    runs-on: ubuntu-latest
    needs: build-and-package
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 确保获取完整历史记录
      
      - name: Generate Changelog
        run: |
          # 获取当前日期
          CURRENT_DATE=$(date +"%Y-%m-%d")
          
          # 获取所有标签，按创建日期降序排序
          TAGS=($(git tag --sort=-creatordate))
          
          LATEST_TAG=${TAGS[0]}
          
          if [ ${#TAGS[@]} -ge 2 ]; then
            PREVIOUS_TAG=${TAGS[1]}
            # 获取两个标签之间的提交记录
            git log --pretty=format:"* %s" "$PREVIOUS_TAG..$LATEST_TAG" > temp_changelog.md
          else
            # 只有一个标签，获取该标签的所有提交记录
            git log --pretty=format:"* %s" "$LATEST_TAG" > temp_changelog.md
          fi
          
          # 生成 CHANGELOG.md
          echo "# $LATEST_TAG ($CURRENT_DATE)" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          cat temp_changelog.md >> CHANGELOG.md
          rm temp_changelog.md
      
      - name: Upload Changelog
        uses: actions/upload-artifact@v3
        with:
          name: changelog
          path: CHANGELOG.md

  create-release:
    runs-on: ubuntu-latest
    needs: [build-and-package, generate-changelog]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Download Changelog
        uses: actions/download-artifact@v3
        with:
          name: changelog
          path: .
      
      # 明确下载每个工件
      - name: Download Windows x64 Artifact
        uses: actions/download-artifact@v3
        with:
          name: jtreesize-${{ needs.build-and-package.outputs.version }}-windows-latest-x64
          path: dist/

      - name: Download Windows aarch64 Artifact
        uses: actions/download-artifact@v3
        with:
          name: jtreesize-${{ needs.build-and-package.outputs.version }}-windows-latest-aarch64
          path: dist/
      
      - name: Download Ubuntu x64 Artifact
        uses: actions/download-artifact@v3
        with:
          name: jtreesize-${{ needs.build-and-package.outputs.version }}-ubuntu-latest-x64
          path: dist/

      - name: Download Ubuntu aarch64 Artifact
        uses: actions/download-artifact@v3
        with:
          name: jtreesize-${{ needs.build-and-package.outputs.version }}-ubuntu-latest-aarch64
          path: dist/
      
      - name: Download macOS x64 Artifact
        uses: actions/download-artifact@v3
        with:
          name: jtreesize-${{ needs.build-and-package.outputs.version }}-macos-latest-x64
          path: dist/

      - name: Download macOS aarch64 Artifact
        uses: actions/download-artifact@v3
        with:
          name: jtreesize-${{ needs.build-and-package.outputs.version }}-macos-latest-aarch64
          path: dist/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.build-and-package.outputs.version }}
          name: ${{ needs.build-and-package.outputs.version }}
          body_path: CHANGELOG.md
          files: |
            dist/jtreesize-${{ needs.build-and-package.outputs.version }}-Windows-x64.exe
            dist/jtreesize-${{ needs.build-and-package.outputs.version }}-Linux-x64.tar.gz
            dist/jtreesize-${{ needs.build-and-package.outputs.version }}-Linux-aarch64.tar.gz
            dist/jtreesize-${{ needs.build-and-package.outputs.version }}-macOS-x64.dmg
            dist/jtreesize-${{ needs.build-and-package.outputs.version }}-macOS-aarch64.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}